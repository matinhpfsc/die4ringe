<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
      <title>Die vier Schl&uuml;ssel</title>
   </head>
   <body onLoad="init();">
     <style>
         .verb, .object {
            cursor:pointer;
         }
     </style>
     <script>

         var commands = [
            {
               pattern: /say\s+"([^"]*)"(\s+in\s+(#[0-9A-F]{6}))?/g,
               func: function(groups) {say(groups[3], groups[1]);}
            }
         ];

         function createTextReader(text) {
            var currentIndex = 0;
            var lines = text.replace(/\r/g, "").split("\n");

            return {
               currentLine: function() {
                  return currentIndex < lines.length ? lines[currentIndex] : null;
               },
               nextLine: function() {
                  if (currentIndex < lines.length) currentIndex++;
               },
               lastLine: function() {
                  if (currentIndex > 0) currentIndex--;
               },
            };
         }

         function getStatement(reader) {
            var line = reader.currentLine(); 
            var result;
            for (command of commands) {
               result = line.match(command.pattern);
               if (result != null) {
                  return function() { command.func(result) };
               }
            }
            return null;
         }


         function getIndentLevel(line) {
            if (line == null) {
               return -1;
            }
            var regex = /^\s*/g;
            var indent = regex.exec(line);
            if (indent == null) {
               return 0;
            }
            return indent[0].length;
         }

         function getBlockStatements(reader) {
            var statements = [];
            if (reader.currentLine() == null) {
               return statements;
            }
            var indentLevel = getIndentLevel(reader.currentLine());
            while (indentLevel <= getIndentLevel(reader.currentLine())) {
               statements.push(getStatement(reader));
               reader.nextLine();
            }
            return statements;
         }

         var commandRules = {
            "Schau an": {
               "Kühlschrank": [
                  function() { print("Dies ist ein cooler Kühlschrank.");},
                  function() { print("Ok, war ein blöder Spruch.")}
               ],
               "*": [ function() { print("Ich kann nichts besonderes erkennen.") }]
            },
            "Rede mit": {
               "Tisch": [
                  function() { print("Ich bin Peter Kowalsky, ein mächtiger Seeräuber.");},
                  function() { print("Oh...sieh' mal an! Eine Schatztruhe!");},
                  function() { inventory.push("Schatztruhe"); setInventory(); nextStep();},
                  function() { wait(1); },
                  function() { print("Da wollen wir doch gleich mal sehen, was da drinnen ist.");},
                  function() { print("Ahh, eine Flasche Brause, eine Brille und ein Fisch.");},
                  function() { inventory.push("Brauseflasche");
                               inventory.push("Brille");
                               inventory.push("roter Fisch");
                               setInventory(); nextStep();},
                  function() { wait(1); },
                  function() { print("Die leere Truhe brauche ich ja dann nicht mehr");},
                  function() { inventory.splice(inventory.indexOf("Schatztruhe"), 1); setInventory(); nextStep();}
               ]
            }
         };

         //var inventory = ["Schere", "Paket", "Schlüssel", "Ring", "Tanzschuh", "roter Fisch", "ein kleines Etwas mit einem Nagel drin"];
         var inventory = [];
         var commandParts = ["Gehe zu"];

         var steps = [];
         var index = 0;

         function wait(seconds) {
             setTimeout(nextStep, 1000 * seconds);
         }

         function print(text) {
            var dialogDiv =  document.getElementById('dialog');
            dialogDiv.innerHTML = text;
            setTimeout(function() { dialogDiv.innerHTML = ""; nextStep() }, 25 * text.length + 2000);
         }

         function setInventory() {
             var inventoryDiv = document.getElementById('inventory');
             inventoryDiv.innerHTML = inventory.map(function(s) { return '<a href="">' + s + '</a>';}).join("<br/>");
         }

         function nextStep() {
            if (index < steps.length) {
               var step = steps[index];
               index++;
               step();
            }
         }

         function init() {
            var verbDivs = document.getElementsByClassName("verb");
            for (var i = 0; i < verbDivs.length; i++) {
               verbDivs[i].onclick = function(e) {
                                          var text = this.innerHTML;
                                          commandParts = [text];
                                          setCommand();
                                      };
            }
            var objectDivs = document.getElementsByClassName("object");
            for (var i = 0; i < objectDivs.length; i++) {
               objectDivs[i].onclick = function(e) {
                                          var text = this.innerHTML;
                                          commandParts.push(text);
                                          setCommand();
                                      };
            }
            setInventory();
            nextStep();
         }

         function clearCommandLine() {
            commandParts = ["Gehe zu"];
            var commandDiv = document.getElementById("command");
            commandDiv.innerHTML = commandParts.join(" ");
         }

         function setCommand() {
            var commandDiv = document.getElementById("command");
            commandDiv.innerHTML = commandParts.join(" ");
            var d = commandRules;
            for (commandIndex = 0; commandIndex < commandParts.length; commandIndex++) {
               if (commandParts[commandIndex] in d) {
                  d = d[commandParts[commandIndex]];
               }
               else {
                  if ("*" in d) {
                     d = d["*"];
                  }
                  else {
                     d = [];
                  }
               }
               if (Array.isArray(d)) {
                  index = 0;
                  steps = d.concat([clearCommandLine]);
                  nextStep();
                  break;
               }
            }
         }

/*
         function run(statements) {
            for (var i = 0; i < statements.length; i++) {
               statements[i].run();
            }
         }

         function condition(branches) {
            for (var i = 0; i < branches.length; i++) {
               var branch = branches[i];
               if (branch.checkFunction(branch.firstArgument,
                        branch.secondArgument)) {
                  run(branch.statements);
                  return;
               }
            }
         }
      */
        
      </script>
      <div id="dialog" style="min-height:7em; width:30em; margin:auto;"><!--Ich kann die Dose ohne Dosenöffner nicht öffnen. Da fällt mir folgender Witz ein: Wie nennt man einen Dosenöffner ohne Wasserhahn? Enemene Miste was rappelt in der Kiste? Ich weiß es nicht.--></div>
      <div id="room" style="border-style:solid; width:30em; margin:auto;">In einer Ecke steht eine kleine Miniküche mit <span class="object">Kochfeld</span>, <span class="object">Spüle</span> und <span class="object">Kühlschrank</span>. In der Ecke gegenüber steht ein Küchenschrank mit <span class="object">Besteck</span>-|Besteckschublade_ und <span class="object">Zubehörschublade</span> sowie einem <span class="object">Regal</span> für Gläser und Tassen und einem <span class="object">Geschirrfach</span>. In der Mitte steht ein <span class="object">Tisch</span> mit Stühlen.</div>
      <div id="command" style="margin:1em; text-align:center;">Gehe zu</div>
      <div style="width:40em; margin:auto;">
      <table style="width:20em; float:left;">
         <tr><td><div class="verb">Nimm</div></td><td><div class="verb">Öffne</div></td><td><div class="verb">Ziehe</div></td></tr>
         <tr><td><div class="verb">Gib</div></td><td><div class="verb">Schließe</div></td><td><div class="verb">Drücke</div></td></tr>
         <tr><td><div class="verb">Rede mit</div></td><td><div class="verb">Schau an</div></td><td><div class="verb">Benutze</div></td></tr>
      </table>
      <div>
      <div id="inventory" style="overflow:auto; height:6em;"></div></div>
      </div>
   </body>
</html>
